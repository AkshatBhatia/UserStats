<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Twitter Stats</title>
    <style type="text/css">
    </style>
</head>
<body>
<!-- ========= -->
<!-- Your HTML -->
<!-- ========= -->
<div class="container">
    <section id="twitterstatsapp">
        <header id="header">
            <h1>Twitter Stats</h1>
        </header>
        <div class="input-group">
            <input id="user" type="text" class="form-control" placeholder="Search for user tweets">
            <span class="input-group-btn">
                <button class="search btn btn-default" type="button">Go!</button>
            </span>
        </div><!-- /input-group -->
        <section id = "charts">
            <div id="chart1"><svg></svg></div>
        </section>
        <section id="main">
            <table style="width:100%" class="table table-striped table-bordered table-hover sortable">
                <thead>
                    <tr>
                        <th>TweetId</th>
                        <th>Author</th>
                        <th>Text</th>
                        <th data-defaultsort="desc">Favorites</th>
                        <th>Retweets</th></tr>
                </thead>
            <tbody id="tweet-list">
            </tbody>
            </table>
        </section>
    </section>
</div>
<!-- ========= -->
<!-- Libraries -->
<!-- ========= -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" type="text/javascript"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js" type="text/javascript"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.2.3/backbone-min.js" type="text/javascript"></script>

<!-- Bootstrap-->
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

<!-- D3 -->
<script src="http://d3js.org/d3.v3.min.js"  charset="utf-8"></script>

<!--Nvd3-->
<script src="https://cdn.rawgit.com/novus/nvd3/v1.8.1/build/nv.d3.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.rawgit.com/novus/nvd3/v1.8.1/build/nv.d3.css">

<!-- =============== -->
<!-- Javascript code -->
<!-- =============== -->
<script type="text/template" id="tweet-template">
    <td><a href='http://www.twitter.com/<%= author %>/status/<%= id_str %>'><%= id_str %></a></td>
    <td><a href='http://www.twitter.com/<%= author %>'><%= author %></a>    </td>
    <td><%= text %></td>
    <td><%= favorite_count %></td>
    <td><%= retweet_count %></td>
</script>

<script type="text/javascript">
    // your JS code goes here
    var app = {}; // create namespace for our app

    //Models
    app.Tweet = Backbone.Model.extend({
       defaults: {
           id_str: "id_str",
           author: "Author",
           text: "This is a tweet text",
           favorite_count: "favorite_count",
           retweet_count: "retweet_count",
       }
    });

    // Collections
    app.Tweets = Backbone.Collection.extend({
        model: app.Tweet,
        url: '/twitterstats/tweets',
        parse: function(data) {
            return data.tweets;
        }
    });

    app.tweets = new app.Tweets();

    // Views
    app.TweetView = Backbone.View.extend({
        tagName: 'tr',
        template: _.template($('#tweet-template').html()),
        render: function(){
            this.$el.html(this.template(this.model.toJSON()));
            return this; // enable chained calls
        }
    });

    app.AppView = Backbone.View.extend({
        el: '#twitterstatsapp',
        userId: '#user',
        user: '',
        headers: _.template('<tr><th>TweetId</th><th>Author</th><th>Text</th><th data-defaultsort="desc">Favorites</th><th>Retweets</th></tr>'),

        events: {
            "click .search": "searchUser",
        },
        initialize: function () {
            app.tweets.on('reset', this.addAll, this);
            this.fetchTweets();
        },
        fetchTweets: function() {
            var that = this;
            app.tweets.fetch({data: {user: this.user},
            success: function () {
                drawGraph();
                that.addAll();
            }});
        },
        addOne: function(tweet){
            var view = new app.TweetView({model: tweet});
            this.$('#tweet-list').append(view.render().el);
        },
        addAll: function(){
            console.log("Reset is called");
            this.$('#tweet-list').empty();
            app.tweets.each(this.addOne, this);
        },
        searchUser: function(){
            this.user = $(this.userId).val();
            this.fetchTweets();
        }
    });

    var appView = new app.AppView();

    // D3 pair of timeseries for retweets and favorites
    function drawGraph() {
        return nv.addGraph(function () {
            var chart = nv.models.multiBarChart()
                            .height(500)
                            .reduceXTicks(true)   //If 'false', every single x-axis tick label will be rendered.
                            .rotateLabels(0)      //Angle to rotate x-axis labels.
                            .showControls(false)   //Allow user to switch between 'Grouped' and 'Stacked' mode.
                            .stacked(true)
                            .x(function (d) {
                                return new Date(d.x);
                            })
                    ;

{#            var chart = nv.models.lineWithFocusChart()#}
{#                    .x(function (d) {#}
{#                        return new Date(d.x);#}
{#                    });#}

            chart.xAxis
                    .tickFormat(function(d) { return d3.time.format("%Y-%m-%d")(d) });

            chart.yAxis
                    .tickFormat(d3.format(',.f'));

            chart.xScale = d3.time.scale();

            d3.select('#chart1 svg')
                    .attr("height", 500)
                    .datum(tweetData())
                    .transition().duration(100)
                    .call(chart);

            nv.utils.windowResize(chart.update);

            return chart;
        });
    }

    function retweet_ts() {
        return app.tweets.toJSON()
                .map(function(d) {
                    return {x: d.created_at, y: d.retweet_count};
                }).reverse();
    }

    function favorite_ts() {
        return app.tweets.toJSON()
                .map(function(d) {
                    return {x: d.created_at, y: d.favorite_count};
                }).reverse();
    }

    function tweetData() {
        return [
            {
                key: 'Retweet Count',
                values: retweet_ts()
            },
            {
               key: 'Favorite Count',
                values: favorite_ts()
            }
        ];
    }

    function xDomain() {
        return retweet_ts().map(function(d) { return d.x; });
    }
</script>

</body>
</html>
